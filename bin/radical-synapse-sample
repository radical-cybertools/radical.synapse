#!/usr/bin/env python

import os
import sys
import pprint
import radical.synapse       as rs
import radical.synapse.utils as rsu

# FIXME: support tags as flags

# ------------------------------------------------------------------------------
#
def run_samples (url, time, cpu_flops, cpu_time, 
                 sto_src, sto_in, sto_tgt, sto_out, 
                 sto_buf, mem_rss, n_samples):
    
    samples  = list()

    # assume 1 sample per second -- but that is not interpreted anyway...
    for n in range(n_samples):

        # append TIME sample
        if time:
            samples.append(['time', float(n+1), {'real'       : time}])

        # append CPU sample (set efficiency to 1)
        if cpu_time or cpu_flops:
            samples.append(['cpu', float(n+1),  {'time'       : cpu_time, 
                                                 'flops'      : cpu_flops, 
                                                 'efficiency' : 1}])

        # append STO sample
        if sto_in or sto_out:
            samples.append(['sto', float(n+1),  {'src'        : sto_src, 
                                                 'rsize'      : sto_in, 
                                                 'tgt'        : sto_tgt, 
                                                 'wsize'      : sto_out, 
                                                 'buf'        : sto_buf}])

        # append MEM sample
        if mem_rss:
            samples.append(['mem', float(n+1),  {'size'       : mem_rss}])


    info, ret, out = rs.emulate (samples=samples)
    pprint.pprint (info)

    rsu.store_profile (info, mode='emu', url=url)


# ------------------------------------------------------------------------------
#
def usage (msg=None, noexit=False):

    if  msg:
        print "\n      Error: %s" % msg

    print """
      usage     : %s -m <mode> [-t <seconds>] [-c <seconds>] [-f <flops>]  
                               [-I <source>]  [-i <input>]   
                               [-O <target>]  [-o <output>] 
                               [-b <bufsize]  [-r <memory>]  
                               [-s <samples>] [-u <url>] 

      examples  : %s -m sample -f 10000000

      mode(s)   :

        help    : show this message
        sample  : run the specified load as emulation samples


      arguments :
        
        -t      : number of seconds to spend sleeping
        -c      : number of seconds to spend computing
        -f      : number of flops to emulate
        -I      : name   of file  to read from
        -i      : number of bytes to read from disk
        -O      : name   of file  to write to
        -o      : number of bytes to write to disk
        -b      : number of bytes to use for dist I/O buffering
        -r      : number of bytes to allocate (RSS)
        -s      : number of samples to run with the above configuration
        -u      : database URL (empty string to disable db access)


      Notes     :

        The default mode is 'sample'.

""" % (sys.argv[0], sys.argv[0])

    if  msg:
        sys.exit (1)

    if  not noexit:
        sys.exit (0)


# ------------------------------------------------------------------------------
#
if __name__ == '__main__':

    import argparse
    parser = argparse.ArgumentParser (add_help=False)

    parser.add_argument('-m', '--mode',      dest='mode')
    parser.add_argument('-t', '--time',      dest='time')
    parser.add_argument('-c', '--cputime',   dest='cpu_time')
    parser.add_argument('-f', '--flops',     dest='cpu_flops')
    parser.add_argument('-I', '--source',    dest='sto_src')
    parser.add_argument('-i', '--input',     dest='sto_in')
    parser.add_argument('-O', '--target',    dest='sto_tgt')
    parser.add_argument('-o', '--output',    dest='sto_out')
    parser.add_argument('-b', '--buffer',    dest='sto_buf')
    parser.add_argument('-r', '--memory',    dest='mem_rss')
    parser.add_argument('-s', '--samples',   dest='samples')
    parser.add_argument('-u', '--url',       dest='url')
    parser.add_argument('-h', '--help',      dest='help', action="store_true")

    arguments, args = parser.parse_known_args ()

    mode      = arguments.mode 
    url       = arguments.url 
    time      = arguments.time
    cpu_time  = arguments.cpu_time
    cpu_flops = arguments.cpu_flops
    sto_src   = arguments.sto_src  
    sto_in    = arguments.sto_in   
    sto_tgt   = arguments.sto_tgt
    sto_out   = arguments.sto_out
    sto_buf   = arguments.sto_buf
    mem_rss   = arguments.mem_rss
    samples   = arguments.samples

    if not time      : time      = 0
    if not cpu_time  : cpu_time  = 0
    if not cpu_flops : cpu_flops = 0
    if not sto_src   : sto_src   = None
    if not sto_in    : sto_in    = 0
    if not sto_tgt   : sto_tgt   = None
    if not sto_out   : sto_out   = 0
    if not sto_buf   : sto_buf   = 0
    if not mem_rss   : mem_rss   = 0
    if not samples   : samples   = 1

    time      = float(time     )
    cpu_time  = int  (cpu_time )
    cpu_flops = int  (cpu_flops)
    sto_in    = int  (sto_in   )
    sto_out   = int  (sto_out  )
    sto_buf   = int  (sto_buf  )
    mem_rss   = int  (mem_rss  )
    samples   = int  (samples  )

    if  arguments.help:
        usage ()

    if  not mode:
        mode = 'sample'

    if  mode in ['help']: 
        usage ()

    if not url:
        url = os.environ.get ('RADICAL_SYNAPSE_DBURL')

    if   mode == 'sample'  : run_samples(url, time, cpu_flops, cpu_time, 
                                         sto_src, sto_in, sto_tgt, sto_out,
                                         sto_buf, mem_rss, samples)
    elif mode == 'help'    : usage(noexit=True)
    else                   : usage("unknown mode '%s'" % mode)

# ------------------------------------------------------------------------------

